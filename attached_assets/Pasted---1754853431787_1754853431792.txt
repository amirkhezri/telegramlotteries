طرح فنی جامع و کامل مینی اپ قره کشی های استارز


---

۱. معرفی کلی پروژه

ربات تلگرامی قرعه‌کشی با هدف نمایش و مدیریت پیام‌های قرعه‌کشی رسمی تلگرام و ارائه آن‌ها به کاربران دارای لول مختلف. ربات پیام‌های قرعه‌کشی را از مدیران کانال‌ها دریافت و پس از تأیید ادمین ربات، بر اساس لول کاربران نمایش می‌دهد. همچنین امتیازدهی به کاربران بر اساس عضویت در کانال‌های اسپانسر و رفرال انجام می‌شود.


---

۲. دسته‌بندی کاربران ربات

گروه ۱ - ادمین‌ها (مدیران ربات):
کاربران دارای دسترسی کامل به مدیریت ربات، تایید یا رد پیام‌های قرعه‌کشی، تعیین لول پیام‌ها، مشاهده گزارش‌ها و تنظیمات کلی ربات.
نحوه شناسایی و تشخیص این گروه باید از دو گروه ۲ و ۳ متفاوت باشد و از داخل ربات دسترسیش رو متفاوت کنیم مثلاً می‌تونیم مدیران ربات رو از روی شناسه عددی تلگرامیشون تشخیص بدیم و این شناسه عددی تلگرامی مدیر ربات رو در فایل کانفینگ قرار بدیم و قابل تغییر باشه

تشخیص گروه ۲ و ۳ از طریق سوال پرسیدن در ابتدای استارت کردن ربات از خود کاربر تشخیص داده می‌شه و این رو از خودش می‌پرسیم و می‌تونه انتخاب کنه که جز گروه ۲ یا ۳ باشه و این رو با انتخاب کلیدهایی در ابتدای استارت کردن ربات ازش سوال می‌کنیم پس کاربر گروه ۲ و ۳ در ابتدای استارت کردن ربات ازش سوال میشه می‌تونه هم جز گروه ۲ باشه هم جز گروه ۳ باشه یعنی هر بار با زدن دکمه هر گروه جز همون گروه می‌شه

گروه ۲ - کاربران عادی (شرکت‌کنندگان در قرعه‌کشی):
کاربران عادی که پیام‌های تایید شده قرعه‌کشی را بر اساس لول خود مشاهده می‌کنند، امتیاز کسب می‌کنند و می‌توانند در قرعه‌کشی‌ها شرکت کنند.

گروه ۳ - ارسال‌کنندگان پیام قرعه‌کشی (مدیران کانال یا نمایندگان):
کاربرانی که پیام‌های قرعه‌کشی رسمی کانال‌های خود را به ربات فوروارد می‌کنند تا پس از تایید در ربات منتشر شود.



---

۳. ثبت و شناسایی کاربران

هنگام شروع ربات (دستور /start)، اطلاعات زیر از متادیتای تلگرام ثبت می‌شود:

Telegram User ID (شناسه عددی یکتا)

Username

First Name و Last Name (در صورت وجود)


این شناسه عددی تلگرام کلید اصلی در دیتابیس است که برای شناسایی، دسته‌بندی و دسترسی به داده‌های مرتبط استفاده می‌شود.

اطلاعات پروفایل کاربر به‌روزرسانی می‌شود ولی شناسه عددی ثابت می‌ماند.



---

۴. تشخیص پیام قرعه‌کشی رسمی تلگرام

پیام‌های رسمی قرعه‌کشی تلگرام قابل کپی کردن متن نیستند، فقط قابل فوروارد هستند.

برای جلوگیری از ارسال پیام‌های غیرمرتبط، ربات فقط پیام‌هایی را می‌پذیرد که به صورت فوروارد از کانال برگزارکننده باشند.

تشخیص پیام قرعه‌کشی رسمی تلگرام (اصلی‌ترین بخش)

پیام‌های رسمی قرعه‌کشی قابل کپی کردن متن نیستند و فقط قابل فوروارد شدن هستند. یعنی وقتی کاربر می‌خواهد پیام قرعه‌کشی را به ربات ارسال کند، نمی‌تواند متن آن را تایپ کند بلکه باید حتماً آن پیام را فوروارد کند.

پیام فوروارد شده از کانال‌های برگزارکننده، در متادیتای تلگرام، هیچ متن قابل خواندن (text) ندارد یا متن خیلی محدود و ساختاریافته‌ای دارد (معمولاً جمله‌ای شبیه «کانال X یک قرعه‌کشی جدید برگزار کرد» که تلگرام خودکار اضافه می‌کند).

در اصل، پیام قرعه‌کشی رسمی تلگرام شامل مواردی است که به صورت خودکار توسط تلگرام به صورت قالب خاص و در کانال برگزارکننده منتشر شده:

متنی به صورت قابل فوروارد بدون متن قابل کپی کردن

لیست کانال‌های شرط شرکت در قرعه‌کشی به صورت لینک کلیک‌خور (که هر کانال، لینک ورود به کانال خود را دارد)

تاریخ و ساعت دقیق انتخاب برندگان

شرح جوایز به صورت غیرکپی (مثلاً اشتراک پریمیوم ۳ ماه، یا استارز به تعداد مشخص)


در نتیجه، ربات باید فقط پیام‌هایی را بپذیرد که از کانال (Channel ID) معین فوروارد شده باشند.

برای شناسایی پیام رسمی و جلوگیری از ثبت پیام‌های تکراری:

از Channel ID و Message ID آن پیام فوروارد شده به عنوان شناسه یکتا استفاده می‌شود.

متن پیام فوروارد شده نمی‌تواند به صورت دستی نوشته شود (برای کاربران گروه ۳ فقط اجازه فوروارد است).

بررسی شود که پیام حداقل دارای خصوصیات ساختاری که در بالا ذکر شد باشد (مانند وجود لینک کانال‌های شرط، تاریخ قرعه‌کشی و ...).


پیام‌های فوروارد شده که این مشخصات را نداشته باشند یا از کانال‌های غیرمعتبر باشند، رد می‌شوند.

در صورت تایید، ادمین باید قبل از تایید نهایی، لول دسترسی برای نمایش پیام به کاربران گروه ۲ را تعیین کند.

متن پیام فوروارد شده برای استخراج جزئیات با regex پردازش می‌شود.


---

۵. ساختار دیتابیس پیشنهادی

جدول توضیحات فیلدهای مهم

Users کاربران ربات (ادمین، ارسال‌کننده، عادی) user_id (Telegram ID), username, first_name, last_name, role, points, level, referral_code, referrer_id, is_sponsor_member
Raffles پیام‌های قرعه‌کشی ثبت شده raffle_id, channel_id, message_id, forwarded_message_id, text, prize_description, required_channels, raffle_datetime, level_required, status, created_at, updated_at
User_Seen_Raffles ثبت پیام‌های دیده شده توسط کاربران user_id, raffle_id, seen_at



---

۶. جریان کارکرد ربات

۶.۱ ثبت کاربر

ثبت یا بروز رسانی اطلاعات کاربر هنگام /start با استفاده از Telegram User ID


۶.۲ دریافت پیام قرعه‌کشی (گروه ۳)

دریافت پیام قرعه‌کشی فقط به صورت فوروارد شده از کانال برگزارکننده

بررسی تکراری نبودن پیام بر اساس Channel ID و Message ID

ثبت پیام در دیتابیس با وضعیت pending

ارسال پیام به ادمین برای تایید و تعیین لول


۶.۳ تایید یا رد پیام توسط ادمین (گروه ۱)

مشاهده لیست پیام‌های در انتظار تایید

مشاهده جزئیات استخراج شده از پیام (جوایز، کانال‌های شرط، تاریخ قرعه‌کشی)

تعیین لول دسترسی برای پیام قرعه‌کشی

تایید یا رد پیام

در صورت تایید، فوروارد پیام به کانال مدیریتی (جهت آرشیو و پخش به کاربران)

تغییر وضعیت پیام به approved یا rejected


۶.۴ نمایش پیام‌های قرعه‌کشی به کاربران (گروه ۲)

کاربران با توجه به لول خود فقط پیام‌های تایید شده با لول ≤ لول کاربر را مشاهده می‌کنند

امکان فیلتر پیام‌ها بر اساس:

تاریخ برگزاری قرعه‌کشی (نزدیکی به زمان فعلی)

وضعیت دیده شده / دیده نشده

شرح جوایز (مثلاً فقط اشتراک یا فقط استارز)

کانال برگزارکننده (کانال‌های با بیشترین تعداد قرعه‌کشی)


نمایش پیام‌ها به صورت فوروارد شده به کاربر، بدون ایجاد مزاحمت ارسال خودکار

۶.۵ امتیازدهی و ارتقاء لول

کاربران با عضویت در کانال‌های اسپانسر (کانال‌های مدیریت شده توسط ربات) و فعال‌سازی عضویت توسط دکمه استعلام عضویت، امتیاز کسب می‌کنند

همچنین رفرال (معرفی دوستان) امتیاز اضافی دارد

امتیازهای کسب شده باعث ارتقاء لول و دسترسی به قرعه‌کشی‌های با لول بالاتر می‌شود



---

۷. نکات فنی اضافی

استفاده از regex در ماژول extractor.py برای استخراج:

تاریخ و ساعت قرعه‌کشی

شرح جوایز

کانال‌های شرط شرکت


ذخیره تاریخ و ساعت قرعه‌کشی برای فیلترهای نمایش پیام‌ها

ثبت وضعیت دیده شدن پیام توسط هر کاربر (User_Seen_Raffles)

همه پیام‌ها، دکمه‌ها، و پاسخ‌ها کاملاً فارسی و مطابق اصول UX فارسی

طراحی دکمه‌های منو شامل:

«شرکت در قرعه‌کشی»

«مدیر کانال هستم» (برای ارسال پیام قرعه‌کشی)

«نمایش قرعه‌کشی‌های من» با فیلترهای پیشرفته


کنترل خطاها و پاسخ مناسب هنگام پیام تکراری، عدم عضویت در کانال اسپانسر، و ...



---

۸. معماری و فایل‌های پیشنهادی پروژه

نام فایل شرح وظیفه

bot.py فایل اصلی ربات، هندلرهای پیام و منوها
models.py مدل‌های دیتابیس با SQLAlchemy
extractor.py توابع استخراج اطلاعات از متن پیام فوروارد شده
admin_commands.py دستورات مدیریتی (تایید، رد، تعیین لول)
config.json تنظیمات شامل توکن، شناسه ادمین، لیست کانال‌های اسپانسر
requirements.txt لیست پکیج‌های مورد نیاز (python-telegram-bot==13.15, sqlalchemy, mysqlclient, ...)
README.md دستورالعمل نصب، اجرا، و راه اندازی ربات



---

۹. خلاصه

ثبت دقیق کاربر با شناسه یکتا (Telegram User ID)

شناسایی پیام‌های رسمی قرعه‌کشی فقط از طریق فوروارد پیام

ثبت پیام در دیتابیس با امکان جلوگیری از تکراری بودن

تایید پیام توسط ادمین و تعیین لول دسترسی

نمایش پیام‌ها به کاربران عادی بر اساس لول و فیلترهای متنوع

سیستم امتیازدهی بر اساس عضویت در کانال اسپانسر و رفرال

همه تعاملات به زبان فارسی و طراحی UI/UX ساده



---

در نهایت باید بهت بگم اینکه من گفتم پس از تایید مدیر ربات پیام‌های قرعه کشی به یک کانالی ارسال میشن که بعداً بتونیم از اونجا برای مخاطبین ربات ارسالشون کنیم این یک پیشنهاد بود و اگر تو راه بهتری سراغ داری که بشه این پیام‌ها رو در دیتابیس عیناً ذخیره کرد و بعداً به صورت فوروارد شده به مخاطبینی که می‌خوان قرعه‌کشی‌ها را مشاهده کنند در درون ربات فوروارد کنیم اون راه رو انجام بده